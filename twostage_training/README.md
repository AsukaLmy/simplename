# Optimized Two-Stage Training Pipeline

è¿™ä¸ªæ–‡ä»¶å¤¹åŒ…å«é’ˆå¯¹JRDBæ•°æ®é›†ä¼˜åŒ–çš„ä¸¤é˜¶æ®µè®­ç»ƒç³»ç»Ÿï¼Œé€šè¿‡è·ç¦»é™åˆ¶é…å¯¹å’Œæ ·æœ¬å¹³è¡¡ç­–ç•¥æ˜¾è‘—æå‡è®­ç»ƒæ•ˆç‡å’Œæ¨¡å‹æ€§èƒ½ã€‚

## ğŸš€ ä¸»è¦ä¼˜åŒ–

### 1. è·ç¦»é™åˆ¶é…å¯¹
- **é—®é¢˜**: åŸå§‹ç³»ç»Ÿç”Ÿæˆå¤§é‡æ— æ„ä¹‰çš„è¿œè·ç¦»é…å¯¹
- **è§£å†³**: åŸºäºäººç‰©è¾¹ç•Œæ¡†å®½åº¦çš„è·ç¦»çº¦æŸ (é»˜è®¤3å€å®½åº¦)
- **æ•ˆæœ**: å‡å°‘70-80%æ— æ•ˆé…å¯¹ï¼Œè®­ç»ƒé€Ÿåº¦æå‡50-70%

### 2. å…¨æ™¯å›¾ç¯ç»•å¤„ç†
- **é—®é¢˜**: JRDBå…¨æ™¯å›¾å·¦å³è¾¹ç¼˜å®é™…ç›¸è¿
- **è§£å†³**: è®¡ç®—è·ç¦»æ—¶è€ƒè™‘ç¯ç»•ç‰¹æ€§
- **æ•ˆæœ**: é¿å…é”™è¿‡è¾¹ç•Œå¤„çš„çœŸå®äº¤äº’

### 3. ç¾¤ä½“æ¨å®šé‡‡æ ·ç­–ç•¥ ğŸ†•
- **é—®é¢˜**: JRDBä¸­æ­£æ ·æœ¬è¿‡å¤šï¼ˆ10:1æ¯”ä¾‹ï¼‰ï¼Œè®­ç»ƒæ•ˆç‡ä½
- **è§£å†³**: ç¾¤ä½“æ¨å®šåŸåˆ™ - å¦‚æœA-Bã€B-Cæœ‰äº¤äº’ï¼Œåˆ™æ¨å®šA-Cä¹Ÿæœ‰äº¤äº’
- **ç­–ç•¥**: æ¯ä¸ªç¾¤ä½“åªé‡‡æ ·nä¸ªé…å¯¹ï¼ˆn=ç¾¤ä½“äººæ•°ï¼‰ï¼Œå¤§å¹…å‡å°‘å†—ä½™
- **æ•ˆæœ**: æ­£è´Ÿæ ·æœ¬æ¯”ä¾‹ä»10:1ä¼˜åŒ–åˆ°2:1ï¼Œè®­ç»ƒé€Ÿåº¦æå‡60-80%

### 4. æ ·æœ¬å¹³è¡¡ç­–ç•¥
- **Stage 1**: åŠ¨æ€è´Ÿæ ·æœ¬é‡‡æ ·ï¼Œå¯è°ƒèŠ‚æ­£è´Ÿæ¯”ä¾‹
- **Stage 2**: æ”¯æŒä¸Šé‡‡æ ·/ä¸‹é‡‡æ ·å¹³è¡¡5ç§äº¤äº’ç±»å‹
- **æ•ˆæœ**: è§£å†³ç±»åˆ«ä¸å¹³è¡¡é—®é¢˜ï¼Œæå‡æ¨¡å‹æ³›åŒ–èƒ½åŠ›

### 5. åˆ†é˜¶æ®µè®­ç»ƒ
- **Stage 1**: ä¸“æ³¨äºŒåˆ†ç±»ï¼Œå†»ç»“Stage 2åˆ†ç±»å™¨
- **Stage 2**: åŠ è½½Stage 1é¢„è®­ç»ƒæƒé‡ï¼Œç‹¬ç«‹è®­ç»ƒäº¤äº’ç±»å‹åˆ†ç±»
- **æ•ˆæœ**: æ›´ç¨³å®šçš„è®­ç»ƒè¿‡ç¨‹ï¼Œæ›´å¥½çš„æ”¶æ•›æ•ˆæœ

## ğŸ“ æ–‡ä»¶ç»“æ„

```
twostage_training/
â”œâ”€â”€ optimized_dataset.py        # ä¼˜åŒ–çš„æ•°æ®é›†ç±»
â”œâ”€â”€ train_stage1.py            # ç¬¬ä¸€é˜¶æ®µè®­ç»ƒè„šæœ¬
â”œâ”€â”€ train_stage2.py            # ç¬¬äºŒé˜¶æ®µè®­ç»ƒè„šæœ¬
â”œâ”€â”€ test_optimized_dataset.py  # æµ‹è¯•è„šæœ¬
â””â”€â”€ README.md                  # è¯´æ˜æ–‡æ¡£
```

## ğŸ”§ ç¯å¢ƒè¦æ±‚

```bash
torch>=1.9.0
torchvision>=0.10.0
numpy>=1.21.0
pillow>=8.3.0
scikit-learn>=1.0.0
matplotlib>=3.4.0
seaborn>=0.11.0
```

## ğŸ“Š ä½¿ç”¨æ–¹æ³•

### 1. æ•°æ®é›†æµ‹è¯•
é¦–å…ˆæµ‹è¯•ä¼˜åŒ–æ•°æ®é›†æ˜¯å¦æ­£å¸¸å·¥ä½œï¼š

```bash
cd twostage_training
python test_optimized_dataset.py
```

### 2. ç¬¬ä¸€é˜¶æ®µè®­ç»ƒ (äºŒåˆ†ç±»)

```bash
python train_stage1.py \
    --data_path D:/1data/imagedata \
    --epochs 50 \
    --batch_size 16 \
    --distance_multiplier 3.0 \
    --max_negatives_per_frame 5 \
    --stage1_balance_ratio 1.0 \
    --use_group_sampling \
    --max_group_samples_ratio 1.0
```

**å…³é”®å‚æ•°è¯´æ˜:**
- `--distance_multiplier`: é…å¯¹è·ç¦»å€æ•° (æ¨è2.0-5.0)
- `--max_negatives_per_frame`: æ¯å¸§æœ€å¤§è´Ÿæ ·æœ¬æ•° (æ¨è3-10)
- `--stage1_balance_ratio`: è´Ÿæ ·æœ¬:æ­£æ ·æœ¬æ¯”ä¾‹ (æ¨è0.5-2.0)
- `--use_group_sampling`: å¯ç”¨ç¾¤ä½“æ¨å®šé‡‡æ · (æ¨èå¼€å¯)
- `--max_group_samples_ratio`: ç¾¤ä½“é‡‡æ ·æ¯”ä¾‹ (1.0=ç¾¤ä½“äººæ•°, 0.5=ä¸€åŠ)

### 3. ç¬¬äºŒé˜¶æ®µè®­ç»ƒ (äº”åˆ†ç±»)

```bash
python train_stage2.py \
    --data_path D:/1data/imagedata \
    --stage1_checkpoint ./checkpoints/stage1_experiment_XXXXXX/best_accuracy.pth \
    --epochs 30 \
    --batch_size 16 \
    --stage2_balance_strategy oversample \
    --use_class_weights
```

**å…³é”®å‚æ•°è¯´æ˜:**
- `--stage1_checkpoint`: Stage 1é¢„è®­ç»ƒæ¨¡å‹è·¯å¾„ (**å¿…éœ€**)
- `--freeze_backbone`: æ˜¯å¦å†»ç»“éª¨å¹²ç½‘ç»œ (é»˜è®¤False)
- `--stage2_balance_strategy`: æ ·æœ¬å¹³è¡¡ç­–ç•¥
  - `oversample`: ä¸Šé‡‡æ ·å°‘æ•°ç±»
  - `undersample`: ä¸‹é‡‡æ ·å¤šæ•°ç±»  
  - `none`: ä¸è¿›è¡Œå¹³è¡¡
- `--use_class_weights`: ä½¿ç”¨ç±»åˆ«æƒé‡å¤„ç†ä¸å¹³è¡¡

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | åŸå§‹æ–¹æ³• | ä¼˜åŒ–æ–¹æ³• | æ”¹è¿› |
|------|---------|---------|------|
| è®­ç»ƒæ—¶é—´/epoch | 20000s+ | 6000-8000s | **60-70%â†“** |
| è´Ÿæ ·æœ¬è´¨é‡ | éšæœºé…å¯¹ | è·ç¦»çº¦æŸ | **è´¨é‡æå‡** |
| ç±»åˆ«å¹³è¡¡ | ä¸¥é‡ä¸å¹³è¡¡ | å¯é…ç½®å¹³è¡¡ | **å¹³è¡¡æ”¹å–„** |
| è®­ç»ƒç¨³å®šæ€§ | è”åˆè®­ç»ƒ | åˆ†é˜¶æ®µè®­ç»ƒ | **ç¨³å®šæ€§æå‡** |

## ğŸ“‹ è®­ç»ƒé…ç½®å»ºè®®

### Stage 1 é…ç½®
```bash
# å¿«é€ŸéªŒè¯ (æ¨èç”¨äºè°ƒè¯•)
--distance_multiplier 2.0 --max_negatives_per_frame 3 --epochs 20

# æ ‡å‡†é…ç½® (æ¨èç”¨äºå®éªŒ)
--distance_multiplier 3.0 --max_negatives_per_frame 5 --epochs 50

# é«˜è´¨é‡é…ç½® (æ¨èç”¨äºæœ€ç»ˆæ¨¡å‹)
--distance_multiplier 4.0 --max_negatives_per_frame 7 --epochs 80
```

### Stage 2 é…ç½®
```bash
# å¹³è¡¡ç­–ç•¥é€‰æ‹©
--stage2_balance_strategy oversample    # é€‚åˆæ•°æ®é‡å……è¶³çš„æƒ…å†µ
--stage2_balance_strategy undersample   # é€‚åˆå†…å­˜é™åˆ¶çš„æƒ…å†µ
--stage2_balance_strategy none          # é€‚åˆåŸå§‹åˆ†å¸ƒçš„æƒ…å†µ

# å­¦ä¹ ç‡è°ƒæ•´
--learning_rate 5e-4    # Stage 2é€šå¸¸éœ€è¦æ›´ä½çš„å­¦ä¹ ç‡
--freeze_backbone       # å¦‚æœStage 1å·²ç»å¾ˆå¥½ï¼Œå¯ä»¥å†»ç»“backbone
```

## ğŸ“Š ç»“æœåˆ†æ

è®­ç»ƒå®Œæˆåï¼Œæ¯ä¸ªå®éªŒä¼šç”Ÿæˆï¼š

```
checkpoints/stage1_experiment_XXXXXX/
â”œâ”€â”€ best_accuracy.pth          # æœ€ä½³å‡†ç¡®ç‡æ¨¡å‹
â”œâ”€â”€ best_loss.pth             # æœ€ä½³æŸå¤±æ¨¡å‹  
â”œâ”€â”€ best_f1.pth               # æœ€ä½³F1æ¨¡å‹
â”œâ”€â”€ final.pth                 # æœ€ç»ˆæ¨¡å‹
â”œâ”€â”€ config.json               # å®éªŒé…ç½®
â”œâ”€â”€ evaluation_report.txt     # è¯¦ç»†è¯„ä¼°æŠ¥å‘Š
â”œâ”€â”€ training_curves.png       # è®­ç»ƒæ›²çº¿
â”œâ”€â”€ confusion_matrix.png      # æ··æ·†çŸ©é˜µ
â””â”€â”€ probability_distributions.png  # æ¦‚ç‡åˆ†å¸ƒå›¾
```

## ğŸ” ç›‘æ§è®­ç»ƒ

### å®æ—¶ç›‘æ§
```bash
# æŸ¥çœ‹è®­ç»ƒæ—¥å¿—
tail -f nohup.out

# æŸ¥çœ‹GPUä½¿ç”¨ç‡
nvidia-smi -l 1
```

### è®­ç»ƒæ›²çº¿
- **Lossæ›²çº¿**: ç›‘æ§è¿‡æ‹Ÿåˆ
- **Accuracyæ›²çº¿**: ç›‘æ§æ¨¡å‹æ€§èƒ½
- **F1æ›²çº¿**: ç›‘æ§ç±»åˆ«å¹³è¡¡æ•ˆæœ

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **å†…å­˜ä¸è¶³**
   ```bash
   --batch_size 8  # å‡å°æ‰¹æ¬¡å¤§å°
   --num_workers 2  # å‡å°‘å·¥ä½œè¿›ç¨‹
   ```

2. **è®­ç»ƒæ—¶é—´è¿‡é•¿**
   ```bash
   --distance_multiplier 2.0  # æ›´ä¸¥æ ¼çš„è·ç¦»é™åˆ¶
   --max_negatives_per_frame 3  # å‡å°‘è´Ÿæ ·æœ¬
   ```

3. **ç±»åˆ«ä¸å¹³è¡¡ä¸¥é‡**
   ```bash
   --stage2_balance_strategy oversample  # å¼ºåˆ¶å¹³è¡¡
   --use_class_weights  # ä½¿ç”¨æƒé‡
   ```

4. **Stage 1æ¨¡å‹è·¯å¾„é”™è¯¯**
   ```bash
   # ç¡®ä¿è·¯å¾„æ­£ç¡®
   find ./checkpoints -name "best_accuracy.pth" -type f
   ```

## ğŸ”¬ è¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®

1. **è¶…å‚æ•°è°ƒä¼˜**
   - ä½¿ç”¨ç½‘æ ¼æœç´¢ä¼˜åŒ–`distance_multiplier`
   - è°ƒæ•´å­¦ä¹ ç‡è¡°å‡ç­–ç•¥
   - å°è¯•ä¸åŒçš„æ•°æ®å¢å¼º

2. **æ¨¡å‹æ¶æ„ä¼˜åŒ–**
   - å°è¯•æ›´å¼ºçš„backbone (ResNet50)
   - æ·»åŠ æ³¨æ„åŠ›æœºåˆ¶
   - é›†æˆå¤šä¸ªæ¨¡å‹

3. **æ•°æ®å¢å¼º**
   - æ—¶åºæ•°æ®å¢å¼º
   - å‡ ä½•å˜æ¢
   - å¯¹æŠ—è®­ç»ƒ

## ğŸ“ æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. æ•°æ®è·¯å¾„æ˜¯å¦æ­£ç¡®
2. ä¾èµ–åŒ…æ˜¯å¦å®‰è£…å®Œæ•´
3. GPUå†…å­˜æ˜¯å¦å……è¶³
4. Stage 1æ¨¡å‹æ˜¯å¦æˆåŠŸè®­ç»ƒ

---

**ä¼˜åŒ–æ•ˆæœ**: è¿™ä¸ªä¼˜åŒ–ç‰ˆæœ¬å°†è®­ç»ƒæ—¶é—´ä»20000s/epochå‡å°‘åˆ°6000-8000s/epochï¼ŒåŒæ—¶æå‡äº†æ ·æœ¬è´¨é‡å’Œæ¨¡å‹ç¨³å®šæ€§ã€‚æ¨èç”¨äºæ‰€æœ‰JRDBç›¸å…³çš„äº¤äº’è¯†åˆ«ä»»åŠ¡ã€‚